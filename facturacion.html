<!doctype html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>RSF - Facturación</title><link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
<link rel="shortcut icon" href="assets/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="manifest" href="assets/site.webmanifest">
<link rel="stylesheet" href="assets/style.css"></head><body><header class="topbar">
  <div class="brand">
    <div class="logo" id="logo-container"></div>
    <h1 data-i18n="brand">RESTAURANTES SIN FRONTERAS</h1>
  </div>
  <nav class="nav">
    <a href="index.html" data-i18n="nav_dashboard">Dashboard</a>
    <a href="restaurantes.html" data-i18n="nav_restaurants">Restaurantes</a>
    <a href="menus.html" data-i18n="nav_menus">Menús</a>
    <a href="facturacion.html" data-i18n="nav_billing">Facturación</a>
    <a href="reportes.html" data-i18n="nav_reports">Reportes</a>
    <a href="opiniones.html" data-i18n="nav_opinions">Opiniones</a>
  </nav>
  <div class="controls">
    <select id="lang-select" onchange="setLang(this.value)"><option value="es">ES</option><option value="en">EN</option></select>
    <button id="login-btn" onclick="showLogin()" data-i18n="login">Login</button>
    <span id="user-badge" class="user-badge hidden"></span>
  </div>
</header>

<main class="container">
<section class="card">
<h2>Facturación</h2>
<div class="card">
  <label>Restaurante:<select id="bill-rest-select"></select></label>
  <div id="order-area"></div>
  <button onclick="createInvoice()" data-readonly-for-viewer>Generar Factura</button>
</div>
<div class="card">
  <h3>Facturas</h3>
  <table><thead><tr><th>ID</th><th>Restaurante</th><th>Fecha</th><th>Total</th><th>Acciones</th></tr></thead><tbody id="invoices-tbody"></tbody></table>
</div>
</section>
</main>
<footer class="footer">© <span id="year"></span> RESTAURANTES SIN FRONTERAS - RSF. <span data-i18n="rights">Todos los derechos reservados.</span></footer>
<script src="assets/app.js"></script>
<script>
function populateBillRest(){ const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); const sel = document.getElementById('bill-rest-select'); sel.innerHTML=''; (data.restaurants||[]).forEach(r=>{ const o = document.createElement('option'); o.value=r.id; o.textContent = r.name+' — '+r.city; sel.appendChild(o); }); if(sel.options.length) sel.value = sel.options[0].value; renderOrderArea(); renderInvoicesList(); }
function renderOrderArea(){ const rid = document.getElementById('bill-rest-select').value; const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); const r = (data.restaurants||[]).find(x=>x.id===rid); const area = document.getElementById('order-area'); area.innerHTML=''; if(!r) return; r.menu.forEach(m=>{ const div = document.createElement('div'); div.innerHTML = `<label>${m.name} (${m.price}) — <input type="number" min="0" value="0" data-mid="${m.id}" data-price="${m.price}" /></label>`; area.appendChild(div); }); }
function createInvoice(){ const rid = document.getElementById('bill-rest-select').value; const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); const r = (data.restaurants||[]).find(x=>x.id===rid); const inputs = Array.from(document.querySelectorAll('#order-area input')); const items = []; inputs.forEach(inp=>{ const qty = parseFloat(inp.value)||0; if(qty>0){ const id = inp.dataset.mid; const price = parseFloat(inp.dataset.price)||0; const menuItem = r.menu.find(m=>m.id===id); items.push({ id, name: menuItem.name, price, qty, subtotal: price*qty }); } }); if(items.length===0){ alert('Agrega al menos un platillo'); return; } const total = items.reduce((s,i)=>s+i.subtotal,0); const invoice = { id:'inv-'+Date.now(), restaurantId:rid, restaurantName:r.name, date:new Date().toISOString(), items, total }; data.invoices = data.invoices||[]; data.invoices.push(invoice); localStorage.setItem('rsf_data_v2', JSON.stringify(data)); renderInvoicesList(); alert('Factura generada'); }
function renderInvoicesList(){ const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); const tbody = document.getElementById('invoices-tbody'); tbody.innerHTML=''; (data.invoices||[]).slice().reverse().forEach(inv=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${inv.id}</td><td>${inv.restaurantName}</td><td>${new Date(inv.date).toLocaleString()}</td><td>${inv.total}</td><td><button onclick="viewInvoice('${inv.id}')">Ver</button> <button onclick="printInvoice('${inv.id}')" data-no-delete-for-staff>Imprimir</button> <button onclick="deleteInvoice('${inv.id}')" data-no-delete-for-staff>Eliminar</button></td>`; tbody.appendChild(tr); }); }
function viewInvoice(id){ const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); const inv = (data.invoices||[]).find(i=>i.id===id); if(!inv) return; let txt = `Factura ID: ${inv.id}\nRestaurante: ${inv.restaurantName}\nFecha: ${(new Date(inv.date)).toLocaleString()}\n\nItems:\n`; inv.items.forEach(it=> txt+=`${it.qty} x ${it.name} @ ${it.price} = ${it.subtotal}\n`); txt+=`\nTotal: ${inv.total}`; const w = window.open('', '_blank'); w.document.write('<pre style="font-family:monospace;padding:20px;">'+txt.replace(/</g,'&lt;')+'</pre>'); w.document.close(); }
function printInvoice(id){ window.open('assets/invoice_print.html?inv='+encodeURIComponent(id),'_blank'); }
function deleteInvoice(id){ if(!confirm('Eliminar factura?')) return; const data = JSON.parse(localStorage.getItem('rsf_data_v2')||'{}'); data.invoices = (data.invoices||[]).filter(i=>i.id!==id); localStorage.setItem('rsf_data_v2', JSON.stringify(data)); renderInvoicesList(); }
document.addEventListener('DOMContentLoaded', ()=>{ populateBillRest(); applyPermissions(); applyLang(); document.getElementById('year').textContent = new Date().getFullYear(); document.getElementById('bill-rest-select').addEventListener('change', renderOrderArea); });
</script>
</body></html>
